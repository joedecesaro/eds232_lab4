---
title: "lab4c - iNaturalist"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load libraries
librarian::shelf(
  digest, dplyr, DT, purrr, readr, tidyr, keras, stringr, glue)

```

# Lac 4c - iNaturalist
## Set Up
```{r}
# path to folder containing species directories of images
dir_src  <- "/courses/EDS232/inaturalist-2021/train_mini"
dir_dest <- "~/EDS232/eds232_lab4/inat"
dir.create(dir_dest, showWarnings = F)

# get list of directories, one per species (n = 10,000 species)
dirs_spp <- list.dirs(dir_src, recursive = F, full.names = T)
n_spp <- length(dirs_spp)

# set seed (for reproducible results) 
# just before sampling (otherwise get different results)
# based on your username (unique amongst class)
Sys.info()[["user"]] %>% 
  digest::digest2int() %>% 
  set.seed()
i10 <- sample(1:n_spp, 10)

# show the 10 indices sampled of the 10,000 possible 
i10
```


```{r}
# show the 10 species directory names
basename(dirs_spp)[i10]
```

```{r}
# show the first 2 species directory names
i2 <- i10[1:2]
basename(dirs_spp)[i2]
```

```{r}
# setup data frame with source (src) and destination (dest) paths to images
d <- tibble(
  set     = c(rep("spp2", 2), rep("spp10", 10)),
  dir_sp  = c(dirs_spp[i2], dirs_spp[i10]),
  tbl_img = map(dir_sp, function(dir_sp){
    tibble(
      src_img = list.files(dir_sp, full.names = T),
      subset  = c(rep("train", 30), rep("validation", 10), rep("test", 10))) })) %>% 
  unnest(tbl_img) %>% 
  mutate(
    sp       = basename(dir_sp),
    img      = basename(src_img),
    dest_img = glue("{dir_dest}/{set}/{subset}/{sp}/{img}"))

# show source and destination for first 10 rows of tibble
d %>% 
  select(src_img, dest_img)
```

```{r}
# iterate over rows, creating directory if needed and copying files 
d %>% 
  pwalk(function(src_img, dest_img, ...){
    dir.create(dirname(dest_img), recursive = T, showWarnings = F)
    file.copy(src_img, dest_img) })

# uncomment to show the entire tree of your destination directory
# system(glue("tree {dir_dest}"))
```

## 2 Species (binary classification) - neural net.

```{r}
model <- keras_model_sequential() %>%
  layer_dense(units = 16, activation = "relu", input_shape = c(10000)) %>%
  layer_dense(units = 16, activation = "relu") %>% 
  layer_flatten() %>% 
  layer_dense(units = 1, activation = "sigmoid")

model %>% compile(
  optimizer = "rmsprop",
  loss = "binary_crossentropy",
  metrics = c("accuracy"))
```

```{r}
summary(model)
```

```{r}
train_dir_sp2 <- paste0(dir_dest,"/spp2/train")
validation_dir_sp2 <- paste0(dir_dest,"/spp2/validation")
test_dir_sp2 <- paste0(dir_dest,"/spp2/test")
```


```{r}
# All images will be rescaled by 1/255
train_datagen <- image_data_generator(rescale = 1/255)
validation_datagen <- image_data_generator(rescale = 1/255)
test_datagen <- image_data_generator(rescale = 1/255)

train_generator <- flow_images_from_directory(
  # This is the target directory
  train_dir_sp2,
  # This is the data generator
  train_datagen,
  # All images will be resized to 150x150
  target_size = c(150, 150),
  batch_size = 5,
  # Since we use binary_crossentropy loss, we need binary labels
  class_mode = "binary")

validation_generator <- flow_images_from_directory(
  validation_dir_sp2,
  validation_datagen,
  target_size = c(150, 150),
  batch_size = 5,
  class_mode = "binary")

test_generator <- flow_images_from_directory(
  test_dir_sp2,
  test_datagen,
  target_size = c(150, 150),
  batch_size = 5,
  class_mode = "binary")
```

```{r}
batch <- generator_next(train_generator)
str(batch)
```


```{r}
dir_models <- here::here("data/dl")
dir.create(dir_models, recursive=T, showWarnings = F)
mdl1_h5 <- file.path(dir_models, "INat_binary.h5")
mdl1_history_rds <- file.path(dir_models, "INat_binary_history.rds")
```

```{r}
# check if already fitted and saved model
if (!file.exists(mdl1_history_rds) | !file.exists(mdl1_h5)){
  # fit model
  history <- model %>% fit(
    train_generator,
    steps_per_epoch = 5,
    epochs = 30,
    validation_data = validation_generator,
    validation_steps = 5)
  
  # save fitted model and fitting history
  history %>% saveRDS(mdl1_history_rds)
  model %>% save_model_hdf5(mdl1_h5)
} else{
  # load previously fitted model
  history <- readRDS(mdl1_history_rds)
  model   <- load_model_hdf5(mdl1_h5)
}
```

# 2 Species (binary classification) - neural net.


